<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="author"
      content="Groupe 3 (AVLAH Folly Epiphane | Martial GADJEU)"
    />
    <meta
      name="description"
      content="Study est une PWA conçue pour faciliter la communication et le partage d'informations entre les étudiants en formation à distance."
    />
    <title>Study</title>

    <!-- Import Ant Design Vue Reset CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ant-design-vue@4.2.1/dist/reset.min.css"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="manifest.webmanifest" />
  </head>
  <body>
    <div id="app">
      <a-modal
        v-model:open="userNotExist"
        title="Study"
        width="100%"
        wrap-class-name="full-screen-modal"
        :footer="null"
        @ok="hideChannel"
      >
        <a-form :layout="'vertical'" :model="userForm" @finish="onSaveUser">
          <minidenticon-svg :username="userForm.pseudo"></minidenticon-svg>
          <a-form-item
            label="Entrer votre Pseudo"
            name="pseudo"
            :rules="[{ required: true, message: 'Please input your pseudo!' }]"
          >
            <a-input v-model:value="userForm.pseudo"> </a-input>
          </a-form-item>

          <a-form-item>
            <a-button
              :disabled="userFormDisabled"
              type="primary"
              html-type="submit"
            >
              Continue
            </a-button>
          </a-form-item>
        </a-form>
      </a-modal>
      <a-list item-layout="horizontal">
        <a-list-item
          v-for="item in channels"
          :key="item.id"
          @click="showChannel(item.id)"
        >
          <a-list-item-meta :description="item.description">
            <template #title>
              <a href="#">{{ item.label }}</a>
            </template>
            <template #avatar>
              <a-avatar src="https://joeschmoe.io/api/v1/random" />
            </template>
          </a-list-item-meta>
        </a-list-item>
      </a-list>
      <a-modal
        v-model:open="show"
        title="Channel"
        width="100%"
        wrap-class-name="full-screen-modal"
        :footer="null"
        @ok="hideChannel"
      >
        <a-comment v-for="item in messages" :key="item.id">
          <template #actions>
            <span key="comment-basic-like">
              <a-tooltip title="Like">
                <template v-if="action === 'liked'">
                  <LikeFilled @click="like" />
                </template>
                <template v-else>
                  <LikeOutlined @click="like" />
                </template>
              </a-tooltip>
              <span style="padding-left: 8px; cursor: auto"> {{ likes }} </span>
            </span>
            <span key="comment-basic-dislike">
              <a-tooltip title="Dislike">
                <template v-if="action === 'disliked'">
                  <DislikeFilled @click="dislike" />
                </template>
                <template v-else>
                  <DislikeOutlined @click="dislike" />
                </template>
              </a-tooltip>
              <span style="padding-left: 8px; cursor: auto">
                {{ dislikes }}
              </span>
            </span>
          </template>
          <template #author><a>{{item.senderPseudo}}</a></template>
          <template #avatar>
            <minidenticon-svg :username="item.senderPseudo"></minidenticon-svg>
          </template>
          <template #content>
            <p>{{item.content}}</p>
          </template>
          <template #datetime>
            <a-tooltip
              :title="dayjs(item.createdAt).format('DD-MM-YYYY HH:mm:ss')"
            >
              <span>{{ dayjs(item.createdAt).from() }}</span>
            </a-tooltip>
          </template>
        </a-comment>
        <a-comment>
          <template #avatar>
            <minidenticon-svg :username="userPseudo"></minidenticon-svg>
          </template>
          <template #content>
            <a-form-item>
              <a-textarea v-model:value="newMessage" :rows="4" />
            </a-form-item>
            <a-form-item>
              <a-button
                html-type="submit"
                :disabled="messageBoxDisabled"
                :loading="messageInProgress"
                type="primary"
                @click="sendNewMessage"
              >
                Envoyer
              </a-button>
            </a-form-item>
          </template>
        </a-comment>
      </a-modal>
    </div>

    <!-- Import Vue -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Import dayjs -->
    <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs/locale/fr.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/relativeTime.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/customParseFormat.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/weekday.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/localeData.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/weekOfYear.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/weekYear.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/advancedFormat.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/quarterOfYear.js"></script>
    <!-- Import Ant Design Vue JS -->
    <script src="https://cdn.jsdelivr.net/npm/ant-design-vue@4.2.1/dist/antd.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

    <script type="module">
      const { createApp, ref, reactive, computed, onMounted } = Vue;
      import { minidenticonSvg } from "https://cdn.jsdelivr.net/npm/minidenticons@4.2.1/minidenticons.min.js";

      const { liveQuery } = Dexie;
      var db = new Dexie("StudyDatabase");

      dayjs.locale("fr");
      dayjs.extend(dayjs_plugin_relativeTime);

      const registerServiceWorker = async () => {
        if ("serviceWorker" in navigator) {
          try {
            const registration = await navigator.serviceWorker.register(
              "/sw.js",
              {
                scope: "/",
              }
            );
            if (registration.installing) {
              console.log("Service worker installing");
            } else if (registration.waiting) {
              console.log("Service worker installed");
            } else if (registration.active) {
              console.log("Service worker active");
            }
          } catch (error) {
            console.error(`Registration failed with ${error}`);
          }
        }
      };

      const CACHE_VERSION = 1;

      const app = createApp({
        setup() {
          const userId = ref(localStorage.getItem("userId"));
          const userPseudo = ref(localStorage.getItem("pseudo"));

          const show = ref(false);
          const channels = ref([]);
          const currentChannelId = ref(null);
          const messages = ref([]);

          const likes = ref(0);
          const dislikes = ref(0);
          const action = ref();
          const messageInProgress = ref(false);
          const newMessage = ref("");

          
          const userFormDisabled = computed(() => {
            return !userForm.pseudo;
          });

          const messageBoxDisabled = computed(() => {
            return !newMessage.value;
          });

          const userNotExist = computed(() => {
            return userId.value === null || userId.value === "";
          });

          onMounted(() => {
            registerServiceWorker();

            db.version(1).stores({
              channels: "++id, label",
              messages:
                "++id, senderId, senderPseudo, channelId, createdAt, updatedAt, like, dislike",
            });

            db.channels
              .bulkPut([
                {
                  id: 1,
                  label: "General",
                  description:
                    "Le Canal étudiant pour échanger sur la vie universitaire, les cours et les événements.",
                },
                {
                  id: 2,
                  label: "PWA",
                  description:
                    "Canal PWA : discussions sur le développement et les meilleures pratiques des Progressive Web Apps.",
                },
                {
                  id: 3,
                  label: "MVC",
                  description:
                    "Canal MVC : Échanges sur l'architecture Model-View-Controller, conseils, et meilleures pratiques.",
                },
              ])
              .then(() => {
                return db.channels.toArray();
              })
              .then((channels) => {
                //
              })
              .catch((err) => {
                console.log(err);
              });

            const channelsObservable = liveQuery(() => db.channels.toArray());
            const channelsSubscription = channelsObservable.subscribe({
              next: (result) => (channels.value = result),
              error: (error) => console.error(error),
            });
          });

          const showChannel = (channelId) => {
            currentChannelId.value = channelId;
            db.messages
              .where({ channelId })
              .sortBy("createdAt")
              .then((values) => {
                messages.value = [...values];
                show.value = true;
              })
              .catch((err) => {
                console.log(err);
              });
          };
          const hideChannel = () => {
            currentChannelId.value = null;
            show.value = false;
          };

          const like = () => {
            likes.value = 1;
            dislikes.value = 0;
            action.value = "liked";
          };
          const dislike = () => {
            likes.value = 0;
            dislikes.value = 1;
            action.value = "disliked";
          };

          const userForm = reactive({
            pseudo: "",
          });

          const onSaveUser = ({ pseudo }) => {
            const uuid = crypto.randomUUID();
            localStorage.setItem("userId", uuid);
            localStorage.setItem("pseudo", pseudo);
            userId.value = uuid;
            userPseudo.value = pseudo;
          };

          const sendNewMessage = () => {
            messageInProgress.value = true;
            setTimeout(() => {
              const message = {
                content: newMessage.value,
                senderId: userId.value,
                senderPseudo: userPseudo.value,
                channelId: currentChannelId.value,
                createdAt: dayjs().format(),
                updatedAt: dayjs().format(),
                like: 0,
                dislike: 0,
              };
              db.messages
                .add(message)
                .then((msgId) => {
                  messages.value = [
                    ...messages.value,
                    { ...message, id: msgId },
                  ];
                  newMessage.value = "";
                })
                .catch((err) => {
                  console.log(err);
                });
              messageInProgress.value = false;
            }, 1000);
          };

          return {
            show,
            channels,
            likes,
            dislikes,
            userId,
            userPseudo,
            userNotExist,
            userForm,
            userFormDisabled,
            newMessage,
            messages,
            showChannel,
            hideChannel,
            like,
            dislike,
            onSaveUser,
            sendNewMessage,
            dayjs,
          };
        },
      });
      app.use(antd);
      app.mount("#app");
    </script>
  </body>
</html>
