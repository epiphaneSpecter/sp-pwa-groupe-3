<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="author"
      content="Groupe 3 (Folly Epiphane AVLAH | Martial GADJEU | Hugo JUPPET)"
    />
    <meta
      name="description"
      content="Study est une PWA conçue pour faciliter la communication et le partage d'informations entre les étudiants en formation à distance."
    />
    <meta name="theme-color" content="#001529" />
    <title>Study</title>

    <!-- Import Ant Design Vue Reset CSS -->
    <!-- <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ant-design-vue@4.2.1/dist/reset.min.css"
    /> -->
    <!-- Import Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="manifest.webmanifest" />
  </head>
  <body>
    <div id="app">
      <!-- Header -->
      <header class="header">
        <hgroup>
          <h1>Study</h1>
          <p>L'appli qui te facilite la vie</p>
        </hgroup>
      </header>

      <!-- Main -->
      <main>
        <a-modal
          v-model:open="userNotExist"
          title="Bienvenue sur Study"
          wrap-class-name="pseudo-modal"
          :footer="null"
          @ok="hideChannel"
        >
          <a-form :layout="'vertical'" :model="userForm" @finish="onSaveUser">
            <minidenticon-svg :username="userForm.pseudo"></minidenticon-svg>
            <a-form-item
              label="Entrer votre Pseudo pour continuer"
              name="pseudo"
              :rules="[{ required: true, message: 'Le pseudo est requis!' }]"
            >
              <a-input v-model:value="userForm.pseudo"> </a-input>
            </a-form-item>

            <a-form-item>
              <a-button
                :disabled="userFormDisabled"
                type="primary"
                html-type="submit"
              >
                Continue
              </a-button>
            </a-form-item>
          </a-form>
        </a-modal>

        <a-list item-layout="horizontal">
          <a-list-item
            v-for="item in channels"
            :key="item.id"
            @click="showChannel(item.id, item.label)"
          >
            <a-list-item-meta :description="item.description">
              <template #title>
                <a href="#">{{ item.label }}</a>
              </template>
              <template #avatar>
                <a-avatar :src="generateAvatarUrl(item.label)" />
              </template>
            </a-list-item-meta>
          </a-list-item>
        </a-list>

        <a-modal
          v-model:open="show"
          wrap-class-name="full-screen-modal"
          :closable="false"
          :footer="null"
          @ok="hideChannel"
        >
          <template #title>
            <div class="modal-header-wrapper">
              <span>{{ channelTitle }}</span>
              <button
                type="button"
                aria-label="Close"
                class="ant-modal-close"
                @click="hideChannel"
              >
                <i class="fa-regular fa-circle-xmark"></i>
              </button>
            </div>
          </template>
          <a-comment
            v-for="item in messages"
            :key="item.id"
            :class="{ 'actual-user-comment': isCurrentUser(item.senderId) }"
          >
            <template #actions>
              <span key="comment-basic-like">
                <a-tooltip title="Like">
                  <i
                    :class="['fa', item.action === 'liked' ? 'fa-thumbs-up' : 'fa-regular fa-thumbs-up']"
                    @click="!isCurrentUser(item.senderId) && likeComment(item.id)"
                  ></i>

                  <span style="padding-left: 8px; cursor: auto"
                    >{{ item.likes }}</span
                  ></a-tooltip
                >
              </span>
              <span key="comment-basic-dislike">
                <a-tooltip title="Dislike">
                  <i
                    :class="['fa', item.action === 'disliked' ? 'fa-thumbs-down' : 'fa-regular fa-thumbs-down']"
                    @click="!isCurrentUser(item.senderId) && dislikeComment(item.id)"
                  ></i>
                  <span style="padding-left: 8px; cursor: auto"
                    >{{ item.dislikes }}</span
                  >
                </a-tooltip>
              </span>
            </template>
            <template #author><a>{{ item.senderPseudo }}</a></template>
            <template #avatar>
              <minidenticon-svg
                :username="item.senderPseudo"
              ></minidenticon-svg>
            </template>
            <template #content>
              <p>{{ item.content }}</p>
            </template>
            <template #datetime>
              <a-tooltip
                :title="dayjs(item.createdAt).format('DD-MM-YYYY HH:mm:ss')"
              >
                <span>{{ dayjs(item.createdAt).from() }}</span>
              </a-tooltip>
            </template>
          </a-comment>
          <a-comment>
            <template #avatar>
              <minidenticon-svg :username="userPseudo"></minidenticon-svg>
            </template>
            <template #content>
              <a-form-item>
                <a-textarea
                  v-model:value="newMessage"
                  :rows="1"
                  class="message-input"
                  @keydown="handleKeydown"
                  @input="autoResize"
                  placeholder="Votre message..."
                  :disabled="messageInProgress"
                  ref="textareaRef"
                />
              </a-form-item>
              <a-form-item>
                <a-button
                  html-type="submit"
                  :disabled="messageBoxDisabled || messageInProgress"
                  :loading="messageInProgress"
                  type="primary"
                  @click="sendNewMessage"
                >
                  Envoyer
                </a-button>
              </a-form-item>
            </template>
          </a-comment>
        </a-modal>
      </main>

      <!-- Footer -->
      <footer>
        <p>&copy; 2024 Study. Tous droits réservés.</p>
      </footer>
    </div>

    <!-- Import Vue -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Import dayjs -->
    <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs/locale/fr.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/relativeTime.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/customParseFormat.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/weekday.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/localeData.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/weekOfYear.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/weekYear.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/advancedFormat.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/quarterOfYear.js"></script>
    <!-- Import Ant Design Vue JS -->
    <script src="https://cdn.jsdelivr.net/npm/ant-design-vue@4.2.1/dist/antd.min.js"></script>
    <script src="https://npmcdn.com/dexie@4.0.7/dist/dexie.min.js"></script>

    <script type="module">
      const { createApp, ref, reactive, computed, onMounted, nextTick } = Vue;
      import { minidenticonSvg } from "https://cdn.jsdelivr.net/npm/minidenticons@4.2.1/minidenticons.min.js";

      const { liveQuery } = Dexie;
      var db = new Dexie("StudyDatabase");
      var subscription = null;

      dayjs.locale("fr");
      dayjs.extend(dayjs_plugin_relativeTime);

      const urlBase64ToUint8Array = (base64String) => {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding)
          .replace(/\-/g, "+")
          .replace(/_/g, "/");

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      };

      const getSubscription = async (registration) => {
        subscription = await registration.pushManager.getSubscription();

        if (!subscription) {
          const response = await fetch(
            "https://follyepiphaneavlah.alwaysdata.net/push-server/vapidPublicKey"
          );
          const vapidPublicKey = await response.text();

          const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);

          subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: convertedVapidKey,
          });
        }

        fetch(
          "https://follyepiphaneavlah.alwaysdata.net/push-server/register",
          {
            method: "post",
            headers: {
              "Content-type": "application/json",
            },
            body: JSON.stringify({
              subscription: subscription,
            }),
          }
        );
      };

      const registerServiceWorker = async () => {
        if ("serviceWorker" in navigator) {
          try {
            const registration = await navigator.serviceWorker.register(
              "/sw.js",
              {
                scope: "/",
              }
            );

            var serviceWorker = null;

            if (registration.installing) {
              serviceWorker = registration.installing;
            } else if (registration.waiting) {
              serviceWorker = registration.waiting;
            } else if (registration.active) {
              serviceWorker = registration.active;
            }

            if (serviceWorker) {
              if (serviceWorker.state === "activated") {
                getSubscription(registration)
              }

              serviceWorker.addEventListener("statechange", async (e) => {
                if (e.target.state == "activated") {
                  getSubscription(registration)
                }
              });
            }
          } catch (error) {
            console.error(`Registration failed with ${error}`);
          }
        }
      };

      const CACHE_VERSION = 1;

      const app = createApp({
        setup() {
          const userId = ref(localStorage.getItem("userId"));
          const userPseudo = ref(localStorage.getItem("pseudo"));

          const show = ref(false);
          const channels = ref([]);
          const channelTitle = ref("");
          const currentChannelId = ref(null);
          const messages = ref([]);

          const messageInProgress = ref(false);
          const newMessage = ref("");

          const textareaRef = ref(null);

          const userFormDisabled = computed(() => {
            return !userForm.pseudo;
          });

          const messageBoxDisabled = computed(() => {
            return !newMessage.value;
          });

          const userNotExist = computed(() => {
            return userId.value === null || userId.value === "";
          });

          onMounted(() => {
            registerServiceWorker();

            db.version(1).stores({
              channels: "++id, label",
              messages:
                "++id, senderId, senderPseudo, channelId, createdAt, updatedAt, likes, dislikes, action",
            });

            db.channels
              .bulkPut([
                {
                  id: 1,
                  label: "Général",
                  description:
                    "Le Canal étudiant pour échanger sur la vie universitaire, les cours et les événements.",
                },
                {
                  id: 2,
                  label: "PWA",
                  description:
                    "Canal PWA : discussions sur le développement et les meilleures pratiques des Progressive Web Apps.",
                },
                {
                  id: 3,
                  label: "MVC",
                  description:
                    "Canal MVC : Échanges sur l'architecture Model-View-Controller, conseils, et meilleures pratiques.",
                },
              ])
              .then(() => {
                return db.channels.toArray();
              })
              .then((channelsArray) => {
                channels.value = channelsArray;
                return db.messages.count();
              })
              .then((count) => {
                if (count === 0) {
                  insertInitialMessages();
                }
              })
              .catch((err) => {
                console.log(err);
              });

            const channelsObservable = liveQuery(() => db.channels.toArray());
            const channelsSubscription = channelsObservable.subscribe({
              next: (result) => (channels.value = result),
              error: (error) => console.error(error),
            });
          });

          const insertInitialMessages = () => {
            db.messages.bulkPut([
              {
                senderId: "1",
                senderPseudo: "Biloute",
                channelId: 1,
                content:
                  "Salut tout le monde! Prêts pour une session de code endiablée?",
                createdAt: dayjs().subtract(2, "day").format(),
                updatedAt: dayjs().subtract(2, "day").format(),
                likes: 1,
                dislikes: 0,
                action: null,
              },
              {
                senderId: "2",
                senderPseudo: "Fifi",
                channelId: 1,
                content:
                  "Salut Biloute, yes à fond! J'ai hâte de travailler sur notre app PWA",
                createdAt: dayjs().subtract(1, "day").format(),
                updatedAt: dayjs().subtract(1, "day").format(),
                likes: 2,
                dislikes: 0,
                action: null,
              },
              {
                senderId: "3",
                senderPseudo: "Véro",
                channelId: 2,
                content:
                  "Quelqu'un travaille sur le projet PWA en ce moment? J'ai besoin de conseils",
                createdAt: dayjs().subtract(12, "hour").format(),
                updatedAt: dayjs().subtract(12, "hour").format(),
                likes: 0,
                dislikes: 0,
                action: null,
              },
              {
                senderId: "1",
                senderPseudo: "Biloute",
                channelId: 3,
                content:
                  "Je galère à bien organiser mon code en MVC... faudrait que je reprenne les cours du Professeur NGU LEUBOU !",
                createdAt: dayjs().subtract(6, "hour").format(),
                updatedAt: dayjs().subtract(6, "hour").format(),
                likes: 1,
                dislikes: 1,
                action: null,
              },
              {
                senderId: "4",
                senderPseudo: "Domi",
                channelId: 3,
                content:
                  "Il a tout expliqué.. il suffisait de suivre les cours!",
                createdAt: dayjs().subtract(6, "hour").format(),
                updatedAt: dayjs().subtract(6, "hour").format(),
                likes: 0,
                dislikes: 2,
                action: null,
              },
            ]);
          };

          const showChannel = (channelId, channelLabel) => {
            Notification.requestPermission().then((result) => {
              if (result === "granted") {
                console.log("ALLOWED");
              }
            });
            currentChannelId.value = channelId;
            channelTitle.value = `${channelLabel}`;
            db.messages
              .where({ channelId })
              .sortBy("createdAt")
              .then((values) => {
                messages.value = [...values];
                show.value = true;
                setTimeout(() => {
                  const container =
                    document.querySelector(".ant-modal-content");
                  if (container) {
                    container.scrollTop = container.scrollHeight;
                  }
                }, 0);
              })
              .catch((err) => {
                console.log(err);
              });
          };

          const hideChannel = () => {
            currentChannelId.value = null;
            show.value = false;
          };

          const likeComment = async (messageId) => {
            const message = messages.value.find((msg) => msg.id === messageId);
            if (!message) return;

            if (message.action === "liked") {
              await db.messages.update(messageId, {
                likes: message.likes - 1,
                action: null,
              });
            } else {
              await db.messages.update(messageId, {
                likes: message.likes + 1,
                dislikes:
                  message.action === "disliked"
                    ? message.dislikes - 1
                    : message.dislikes,
                action: "liked",
              });
            }
            refreshMessages();
          };

          const dislikeComment = async (messageId) => {
            const message = messages.value.find((msg) => msg.id === messageId);
            if (!message) return;

            if (message.action === "disliked") {
              await db.messages.update(messageId, {
                dislikes: message.dislikes - 1,
                action: null,
              });
            } else {
              await db.messages.update(messageId, {
                dislikes: message.dislikes + 1,
                likes:
                  message.action === "liked"
                    ? message.likes - 1
                    : message.likes,
                action: "disliked",
              });
            }
            refreshMessages();
          };

          const refreshMessages = () => {
            db.messages
              .where({ channelId: currentChannelId.value })
              .sortBy("createdAt")
              .then((values) => {
                messages.value = [...values];
              })
              .catch((err) => {
                console.log(err);
              });
          };

          const userForm = reactive({
            pseudo: "",
          });

          const onSaveUser = ({ pseudo }) => {
            const uuid = crypto.randomUUID();
            localStorage.setItem("userId", uuid);
            localStorage.setItem("pseudo", pseudo);
            userId.value = uuid;
            userPseudo.value = pseudo;
          };

          const sendNewMessage = () => {
            if (newMessage.value.trim() === "") {
              return;
            }

            messageInProgress.value = true;

            setTimeout(() => {
              const message = {
                content: newMessage.value,
                senderId: userId.value,
                senderPseudo: userPseudo.value,
                channelId: currentChannelId.value,
                createdAt: dayjs().format(),
                updatedAt: dayjs().format(),
                likes: 0,
                dislikes: 0,
                action: null,
              };

              db.messages
                .add(message)
                .then((msgId) => {
                  messages.value = [
                    ...messages.value,
                    { ...message, id: msgId },
                  ];
                  fetch(
                    "https://follyepiphaneavlah.alwaysdata.net/push-server/sendNotification",
                    {
                      method: "post",
                      headers: {
                        "Content-type": "application/json",
                      },
                      body: JSON.stringify({
                        subscription: subscription,
                        payload: {
                          title: `Un nouveau de message de ${userPseudo.value}`,
                          body: newMessage.value
                        },
                        delay: 0,
                        ttl: 1000,
                      }),
                    }
                  );
                  newMessage.value = "";

                  const textarea = document.querySelector(".message-input");
                  if (textarea) {
                    textarea.style.height = "33px";
                  }

                  setTimeout(() => {
                    const container =
                      document.querySelector(".ant-modal-content");
                    if (container) {
                      container.scrollTop = container.scrollHeight;
                    }
                  }, 0);
                })
                .catch((err) => {
                  console.log(err);
                })
                .finally(() => {
                  messageInProgress.value = false;
                  nextTick(() => {
                    textareaRef.value?.focus();
                  });
                });
            }, 1000);
          };

          const isCurrentUser = (senderId) => {
            return senderId === userId.value;
          };

          const handleKeydown = (event) => {
            if (event.key === "Enter" && !event.shiftKey) {
              event.preventDefault();
              sendNewMessage();
            }
          };

          const autoResize = (e) => {
            const textarea = e.target;
            if (textarea.value.trim() === "") {
              textarea.style.height = "33px";
            } else {
              textarea.style.height = textarea.scrollHeight + "px";
            }
          };

          const generateAvatarUrl = (label) => {
            const baseUrl = "https://ui-avatars.com/api/";
            const params = new URLSearchParams({
              name: label,
              background: "#02bd00", //random
              length: 1,
              size: 128,
              rounded: true,
            });
            return `${baseUrl}?${params.toString()}`;
          };

          return {
            show,
            channels,
            channelTitle,
            userId,
            userPseudo,
            userNotExist,
            userForm,
            userFormDisabled,
            newMessage,
            messages,
            textareaRef,
            messageInProgress,
            messageBoxDisabled,
            showChannel,
            hideChannel,
            likeComment,
            dislikeComment,
            onSaveUser,
            sendNewMessage,
            isCurrentUser,
            handleKeydown,
            autoResize,
            dayjs,
            generateAvatarUrl,
          };
        },
      });

      app.use(antd);
      app.mount("#app");
    </script>
  </body>
</html>
